daily_trade_limit: 60
min_order_qty_btc: 0.001

mode_a_static_range:
  adx_max: 20
  atr_pct_max: 0.009
  bb_width_max: 0.012
  poc_slope_max: 0.001
  tp_pct: [0.004, 0.008]
  sl_pct: [0.005, 0.009]
  max_add_stages: 3
  stage_allocation: [0.4, 0.35, 0.25]
  add_cooldown_sec: 300
  entry_cooldown_same_dir_sec: 300
  leverage: [3, 5]
  range_position_long: 0.15
  range_position_short: 0.85
  anti_chase_impulse_max: 0.6
  # Step 10: new config keys
  edge_buffer_pct: 0.001
  order_ttl_sec: 300
  signal_levels:
    S0_observe: 0
    S1_entry: 1
    S2_conviction: 2

mode_b_volatile_range:
  adx_max: 25
  drift_poc_slope_min: 0.0015
  no_trade_zone_edge_pct: 0.002
  trade_zone_center_pct: 0.003
  tp_pct: [0.003, 0.006]
  sl_pct: [0.007, 0.012]
  max_add_stages: 2
  rebuild_cooldown_candles: 10
  leverage: [3, 5]
  # Step 10: new config keys
  size_multiplier: 0.7
  require_spread_ok: true
  require_liquidity_ok: true

mode_c_shock_breakout:
  volume_z_min: 2.0
  impulse_min: 1.5
  breakout_buffer_pct: 0.002
  tp1_pct: [0.006, 0.010]
  trailing_activate_pct: 0.008
  trailing_pct: 0.005
  sl_atr_multiplier: 1.5
  max_add_stages: 2
  leverage: [3, 8]
  # Step 10: new config keys
  news_override_min_score: 60
  news_override_confirmation_candles: 1
  trailing_stop_enabled: true

# ── Strategy V3: Regime Switching + Chase Entry Suppression ──
strategy_v3:
  enabled: true    # feature flag — V3 활성화됨

  # 레짐 분류
  drift_static_max: 0.0003
  drift_trend_min: 0.0008
  adx_range_max: 20
  adx_breakout_min: 28
  regime_confirm_bars: 3
  regime_min_dwell_sec: 300
  cooldown_after_stop_sec: 600
  breakout_bb_expand_min: 1.3
  breakout_volume_z_min: 1.5

  # Static Range
  poc_band_atr_mult: 0.5
  poc_band_va_mult: 0.15
  edge_score_bonus: 25
  poc_zone_penalty: 40
  edge_overshoot_atr_mult: 1.5
  edge_overshoot_penalty: 30

  # Drifting Range
  drift_aligned_bonus: 15
  drift_counter_penalty: 50
  retest_confirm_bars: 3
  poc_support_tolerance_atr: 0.3

  # Breakout
  breakout_pad_atr_mult: 0.3
  retest_entry_enabled: true
  chase_ban_atr_mult: 2.0
  chase_score_penalty: 40
  breakout_trend_bonus: 25

  # Dynamic Risk
  atr_sl_mult: 1.5
  min_sl_pct: 0.003
  max_sl_pct: 0.02
  tp_r_ratio: 1.2
  breakout_stage_slice_mult: 0.5
  sl_update_min_interval_sec: 300
  sl_update_min_change_pct: 0.1

  # Signal Debounce
  signal_debounce_sec: 300
  post_sl_same_dir_cooldown_sec: 600

  # Strict Breakout 3중 확인
  strict_breakout_n_candles: 3
  strict_breakout_m_outside: 2
  strict_breakout_k_dist: 0.25
  strict_breakout_pct_dist: 0.0015
  strict_breakout_volume_z_min: 1.0
  strict_breakout_atr_ratio_min: 1.5

  # 레짐별 리스크
  static_range_min_sl: 0.005
  static_range_max_sl: 0.009
  drift_min_sl: 0.006
  drift_max_sl: 0.012
  breakout_min_sl: 0.008
  breakout_max_sl: 0.02
  breakout_atr_sl_mult: 2.0
  impulse_chase_threshold: 1.5
  max_stage_v3: 1
  breakout_reverse_block: true

  # Scoring guards
  liquidity_hard_block: true
  spread_hard_block: true
  vol_pct_na_penalty: 10
  non_breakout_impulse_penalty: 20
  non_breakout_impulse_block_mult: 1.5

  # 연속손실 쿨다운
  loss_streak_trigger: 3
  loss_streak_cooldown_sec: 1200
  loss_streak_window_hours: 3

  # Performance guardrails
  mode_cooloff_enabled: true
  mode_cooloff_min_trades: 5
  mode_cooloff_min_winrate: 0.30
  mode_cooloff_hours: 4
  loss_streak_conf_escalation: 5
  loss_streak_slice_mult_2: 0.7
  loss_streak_slice_mult_3: 0.5

  # Adaptive Layers v2.1
  adaptive_dryrun: false
  adaptive_l1_streak_penalty_3: 0.70
  adaptive_l1_cooldown_5_sec: 7200
  adaptive_l1_global_wr_trades: 20
  adaptive_l1_global_wr_low: 0.35
  adaptive_l1_global_wr_recovery: 0.40
  adaptive_l1_global_wr_threshold_add: 10
  adaptive_l1_global_wr_add_conf_min: 60
  adaptive_l2_range_pos_short_min: 0.85
  adaptive_l2_impulse_hard_block: 1.5
  adaptive_l3_peak_upnl_threshold: 0.4
  adaptive_l4_warn_tighten_sec: 120
  adaptive_l4_time_stop_mult: 0.5
  adaptive_l5_trades: 50
  adaptive_l5_min_sample: 10
  adaptive_l5_wr_low: 0.35
  adaptive_l5_wr_recovery: 0.40
  adaptive_l5_penalty: 0.75
  adaptive_combined_penalty_floor: 0.55
  adaptive_anti_paralysis_hours_1: 24
  adaptive_anti_paralysis_hours_2: 36
  # D2-2: 히스테리시스 + 마비 방지 강화
  adaptive_penalty_relax_consecutive: 3    # penalty 완화에 필요한 연속 "개선" 신호 수
  adaptive_24h_zero_trade_partial_reset: true  # 24h 거래 0이면 penalty 부분 리셋

  # P0-1: SL basis conversion
  sl_basis: UPNL_PCT           # PRICE_PCT | UPNL_PCT | EQUITY_PCT
  server_stop_offset_pct: 0.1  # P0-2: server stop 0.1% wider than Python SL

  # P0-4: Shock Guard
  shock_guard_threshold_pct: 1.5
  shock_guard_atr_mult: 2.5
  shock_guard_freeze_sec: 300
  shock_guard_lookback_candles: 3

  # D1-1: PanicGuard — WS 기반 단계적 급락 대응
  panic_guard_tighten_pct: 0.35    # 0.35% adverse → SL 재조정
  panic_guard_reduce_pct: 0.60     # 0.60% adverse → 50% 감축
  panic_guard_close_pct: 1.00      # 1.00% adverse → 전량 청산
  panic_guard_cooldown_sec: 60

  # P1-1: per-mode L1 cooldown (seconds)
  adaptive_l1_cooldown_5_sec_StaticRange: 7200
  adaptive_l1_cooldown_5_sec_MeanReversion: 7200
  adaptive_l1_cooldown_5_sec_TrendFollow: 3600
  adaptive_l1_cooldown_5_sec_Breakout: 3600

# ── Feature Flags (default OFF = FAIL-CLOSED) ──
feature_flags:
  ff_order_backoff_v2: true
  ff_watchdog_warn_not_down: true
  ff_snapshot_root_cause: true
  ff_bundle_cmd: true
  ff_strict_breakout: true
  ff_regime_risk_v3: true
  ff_loss_streak_cooldown: true
  ff_adaptive_layers: true
  ff_trade_switch_reason_line: true
  ff_news_alert_throttle_v2: true
  ff_news_health_command: true
  ff_news_upsert_enabled: true
  # P0 feature flags
  ff_sl_basis_conversion: true      # P0-1: SL PRICE→UPNL 전환 (D0-3: 활성화)
  ff_server_stop_orders: true       # P0-2: 서버사이드 스탑 주문 (D0-3: 활성화)
  ff_global_add_block: true          # D0-1: 전역 ADD 차단 (지혈 — 손익 무관 전면 차단)
  ff_loss_zone_add_block: true      # P0-3: 손실 중 ADD 차단 (즉시 ON)
  ff_shock_guard: true              # P0-4: 1m 급변 방어 (D0-3: 활성화)
  ff_panic_guard_ws: true           # D1-1: WS PanicGuard 데몬 활성화
  ff_health_entry_gate: true        # P0-5: Health 기반 진입 게이트 (즉시 ON)
  ff_debug_risk_commands: true      # P0-6: 리스크 디버그 커맨드 (즉시 ON)
  # D2 feature flags
  ff_no_trade_zone: false           # D2-1: trend_probability 기반 no-trade zone (초기 비활성)
  # P1 feature flags
  ff_l2_strict_short: false         # P1-2: MeanRev SHORT 강화
  # P3 feature flags
  ff_strategy_supervisor: false     # P3-1: 6h 감독 리포트
  ff_config_versioning: false       # P3-2: 설정 버저닝
  ff_auto_apply_conservative: false # P3-3: 보수적 자동 적용
  # Safety hotfix flags
  ff_allow_forced_entry: false       # FORCED=1 강제 진입 허용 여부 (default: 차단)
  ff_signal_spam_guard: true         # 반복 신호 쿨다운 (3회/30분 → 30분 cooldown)
  # Unified Engine v1.1 feature flags
  ff_unified_engine_v11: true         # Master switch (ON)
  ff_pullback_trigger: false          # Phase 2 pullback (기본 OFF)
  ff_chandelier_exit: false           # Phase 4 (기본 OFF)
  # Event Decision Mode — Claude direct decision on EVENT triggers
  ff_event_decision_mode: false       # Claude Decision Mode (기본 비활성, 안전 롤아웃)

# ── UNIFIED ENGINE v1.1 Parameters ──
unified_v11:
  risk_pct: 0.0075                    # 0.75% per trade
  sl_atr_mult: 2.0                    # SL = 2 * ATR_15m
  trail_atr_mult: 2.5                 # Chandelier = 2.5 * ATR
  cap_max_pct: 0.20                   # 20% max capital
  daily_loss_limit_pct: -0.025        # -2.5% daily
  adx_enter_threshold: 27             # ADX enter
  adx_keep_threshold: 23              # ADX keep
  time_stop_hours: 12                 # Time stop
  time_stop_min_r: 1.0                # Min R for time stop
  add_min_r: 1.0                      # +1R for ADD
  add_max_count: 2                    # Max ADDs
  add_size_pct: 0.5                   # ADD = 50% of initial
  signal_cooldown_sec: 900            # 15min cooldown
  cb_block_pct: 0.005                 # 0.5% → block
  cb_reduce_pct: 0.010                # 1.0% → reduce 50%
  cb_close_pct: 0.015                 # 1.5% → close all
